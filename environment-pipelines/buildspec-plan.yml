version: 0.2

env:
  parameter-store:
    SLACK_CHANNEL_ID: /codebuild/slack_pipeline_notifications_test_oauth_channel
    SLACK_TOKEN: /codebuild/slack_oauth_token
  exported-variables:
    - BUILD_ID

phases:
  install:
    commands:
      - export PATH="$CODEBUILD_SRC_DIR/build-tools:$PATH"
  build:
    commands:
      - echo "Terraform Plan Phase"
      - pip install -r requirements.txt
      - python ./platform_notify.py post_job_comment --slack-ref $SLACK_REF --title "Plan" --message "Starting terraform plan phase"
      - echo "Working on environment ${ENVIRONMENT}"
      - echo "Generating manifests"
      - copilot env init --name ${ENVIRONMENT} --profile ${COPILOT_PROFILE} --default-config
      - platform-helper copilot make-addons
      - cd terraform/environments/${ENVIRONMENT}
      - terraform init
      - terraform plan -out=plan.tfplan
  post_build:
    commands:
      - export BUILD_ID="$CODEBUILD_BUILD_ID"
      - python ./platform_notify.py post_job_comment --slack-ref $SLACK_REF --title "Plan" --message "Terraform plan phase complete"
artifacts:
  files:
    - terraform/environments/${ENVIRONMENT}/plan.tfplan
